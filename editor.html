<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactieve Video Editor v2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        video { width: 100%; max-width: 800px; display: block; margin: 20px 0; }
        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .question-item {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        .answer-item {
            margin: 5px 0;
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .correct { background: #d4edda; }
        .success {
            background: #d4edda;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            color: #721c24;
        }
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            overflow: auto;
            padding: 20px;
        }
        .preview-modal.active {
            display: block;
        }
        .preview-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .preview-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            font-size: 20px;
        }
        .preview-close:hover {
            background: rgba(0,0,0,0.9);
        }
        .preview-video-wrapper {
            position: relative;
        }
        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .preview-overlay.active {
            display: flex;
        }
        .preview-question-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
        }
        .preview-question-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        .preview-answer {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .preview-answer:hover {
            background: #e0e0e0;
        }
        .preview-answer.selected {
            border-color: #4CAF50;
        }
        .preview-answer.correct {
            background: #d4edda;
            border-color: #28a745;
        }
        .preview-answer.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }
        .preview-feedback {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: none;
        }
        .preview-feedback.show {
            display: block;
        }
        .preview-feedback.correct {
            background: #d4edda;
            color: #155724;
        }
        .preview-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
        }
        .preview-info-bar {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
        }
        .preview-completion {
            text-align: center;
            padding: 50px 30px;
            display: none;
        }
        .preview-completion.active {
            display: block;
        }
        .preview-completion h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .preview-completion .score {
            font-size: 48px;
            color: #4CAF50;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Interactieve Video Editor v2</h1>
    <p>Versie 1.0 - Maak interactieve video's met meerkeuzevragen</p>

    <div id="message"></div>

    <div class="section">
        <h2>1. Upload Video</h2>
        <input type="file" id="videoInput" accept="video/*" style="display: none;">
        <button id="uploadBtn">üìπ Selecteer Video</button>
        <div id="videoInfo" style="display: none; margin-top: 10px;">
            <p><strong>Bestand:</strong> <span id="fileName"></span></p>
            <p><strong>Grootte:</strong> <span id="fileSize"></span></p>
            <p><strong>Duur:</strong> <span id="fileDuration"></span></p>

        </div>
        <video id="videoPlayer" controls style="display: none;"></video>
    </div>

    <div class="section" id="questionSection" style="display: none;">
        <h2>2. Voeg Vragen Toe</h2>
        <label>Tijdstempel (seconden):</label>
        <input type="number" id="questionTime" placeholder="Bijv. 30" min="0" step="1">
        
        <label>Vraag:</label>
        <textarea id="questionText" rows="3" placeholder="Typ hier je vraag..."></textarea>
        
        <label>Feedback bij correct antwoord:</label>
        <input type="text" id="correctFeedback" placeholder="Bijv. Uitstekend! Goed gedaan!" value="‚úì Correct! Goed gedaan.">
        
        <label>Feedback bij fout antwoord:</label>
        <input type="text" id="incorrectFeedback" placeholder="Bijv. Helaas, dat klopt niet." value="‚úó Helaas, dat is niet correct.">
        
        <label>Antwoorden (vink het juiste aan):</label>
        <div id="answersContainer">
            <div class="answer-item">
                <input type="radio" name="correct" value="0" checked> 
                <input type="text" class="answer-text" placeholder="Antwoord 1">
            </div>
            <div class="answer-item">
                <input type="radio" name="correct" value="1"> 
                <input type="text" class="answer-text" placeholder="Antwoord 2">
            </div>
            <div class="answer-item">
                <input type="radio" name="correct" value="2"> 
                <input type="text" class="answer-text" placeholder="Antwoord 3">
            </div>
            <div class="answer-item">
                <input type="radio" name="correct" value="3"> 
                <input type="text" class="answer-text" placeholder="Antwoord 4">
            </div>
        </div>
        <button id="addQuestionBtn">‚ûï Vraag Toevoegen</button>
    </div>

    <div class="section" id="questionsListSection" style="display: none;">
        <h2>3. Toegevoegde Vragen</h2>
        <div id="questionsList"></div>
        <button id="previewBtn" style="display: none; background: #2196F3; margin-top: 20px;">‚ñ∂Ô∏è Preview Interactieve Video</button>
    </div>

    <div class="section" id="exportSection" style="display: none;">
        <h2>4. Exporteren</h2>
        <p>Download je interactieve video als ZIP-bestand voor gebruik in Rise 360 of LMS.</p>
        <button id="exportBtn">üíæ Download ZIP</button>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-container">
            <button class="preview-close" onclick="closePreview()">‚úï</button>
            <div class="preview-video-wrapper">
                <video id="previewVideo" controls></video>
                <div id="previewOverlay" class="preview-overlay">
                    <div class="preview-question-box">
                        <div id="previewFeedback" class="preview-feedback"></div>
                        <div id="previewQuestionText" class="preview-question-title"></div>
                        <div id="previewAnswersContainer"></div>
                        <div>
                            <button id="previewSubmitBtn">Controleer</button>
                            <button id="previewContinueBtn" style="display: none;">Ga Verder</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="previewInfoBar" class="preview-info-bar">
                <div>Score: <strong id="previewScore">0 / 0</strong></div>
                <div>Vraag <span id="previewCurrent">0</span> van <span id="previewTotal">0</span></div>
            </div>
            <div id="previewCompletion" class="preview-completion">
                <h2>Video Voltooid!</h2>
                <div id="previewFinalScore" class="score"></div>
                <p id="previewFinalMessage"></p>
                <button onclick="restartPreview()">Opnieuw Bekijken</button>
                <button onclick="closePreview()" style="background: #666;">Sluiten</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        console.log('Script gestart!');
        
        let videoFile = null;
        let questions = [];
        const PLAYER_HTML_URL = 'player.html';
        
        const videoInput = document.getElementById('videoInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoInfo = document.getElementById('videoInfo');
        const message = document.getElementById('message');
        const questionSection = document.getElementById('questionSection');
        const questionsListSection = document.getElementById('questionsListSection');
        const exportSection = document.getElementById('exportSection');
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        const exportBtn = document.getElementById('exportBtn');
        const questionsList = document.getElementById('questionsList');
        
        uploadBtn.addEventListener('click', function() {
            console.log('Upload button clicked!');
            videoInput.click();
        });
        
        videoInput.addEventListener('change', function(e) {
            console.log('File selected!');
            const file = e.target.files[0];
            if (!file) return;
            
            console.log('File:', file.name);
            videoFile = file;
            
            const url = URL.createObjectURL(file);
            videoPlayer.src = url;
            videoPlayer.style.display = 'block';
            
            videoPlayer.onloadedmetadata = function() {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatBytes(file.size);
                document.getElementById('fileDuration').textContent = formatTime(videoPlayer.duration);
                videoInfo.style.display = 'block';
                questionSection.style.display = 'block';
                showMessage('Video geladen! Je kunt nu vragen toevoegen.', 'success');
            };
        });
        
        addQuestionBtn.addEventListener('click', function() {
            const time = parseFloat(document.getElementById('questionTime').value);
            const text = document.getElementById('questionText').value.trim();
            const correctFeedback = document.getElementById('correctFeedback').value.trim();
            const incorrectFeedback = document.getElementById('incorrectFeedback').value.trim();
            const answerTexts = document.querySelectorAll('.answer-text');
            const correctRadio = document.querySelector('input[name="correct"]:checked');
            
            if (!time && time !== 0) {
                showMessage('Vul een tijdstempel in', 'error');
                return;
            }
            if (!text) {
                showMessage('Vul een vraag in', 'error');
                return;
            }
            if (!correctFeedback) {
                showMessage('Vul feedback voor correct antwoord in', 'error');
                return;
            }
            if (!incorrectFeedback) {
                showMessage('Vul feedback voor fout antwoord in', 'error');
                return;
            }
            
            const answers = [];
            answerTexts.forEach(function(input, i) {
                if (input.value.trim()) {
                    answers.push({
                        text: input.value.trim(),
                        correct: i === parseInt(correctRadio.value)
                    });
                }
            });
            
            if (answers.length < 2) {
                showMessage('Voeg minimaal 2 antwoorden toe', 'error');
                return;
            }
            
            questions.push({ 
                time: time, 
                question: text, 
                answers: answers,
                correctFeedback: correctFeedback,
                incorrectFeedback: incorrectFeedback
            });
            questions.sort(function(a, b) { return a.time - b.time; });
            
            document.getElementById('questionTime').value = '';
            document.getElementById('questionText').value = '';
            document.getElementById('correctFeedback').value = '‚úì Correct! Goed gedaan.';
            document.getElementById('incorrectFeedback').value = '‚úó Helaas, dat is niet correct.';
            answerTexts.forEach(function(input) { input.value = ''; });
            document.querySelector('input[name="correct"][value="0"]').checked = true;
            
            renderQuestions();
            showMessage('Vraag toegevoegd!', 'success');
            
            // Show preview button if we have questions
            if (questions.length > 0) {
                document.getElementById('previewBtn').style.display = 'inline-block';
            }
        });
        
        function renderQuestions() {
            if (questions.length === 0) {
                questionsListSection.style.display = 'none';
                exportSection.style.display = 'none';
                return;
            }
            
            questionsListSection.style.display = 'block';
            exportSection.style.display = 'block';
            
            questionsList.innerHTML = questions.map(function(q, i) {
                const answersHTML = q.answers.map(function(a) {
                    return '<div class="' + (a.correct ? 'correct' : '') + '" style="padding: 5px; margin: 2px 0;">' +
                        (a.correct ? '‚úì' : '‚óã') + ' ' + a.text + '</div>';
                }).join('');
                
                return '<div class="question-item">' +
                    '<strong>' + formatTime(q.time) + '</strong> - ' + q.question +
                    '<div style="margin-top: 10px;">' + answersHTML + '</div>' +
                    '<button onclick="deleteQuestion(' + i + ')" style="background: #f44336; margin-top: 10px;">Verwijder</button>' +
                    '</div>';
            }).join('');
        }
        
        window.deleteQuestion = function(index) {
            questions.splice(index, 1);
            renderQuestions();
            showMessage('Vraag verwijderd', 'success');
        };
        
        exportBtn.addEventListener('click', async function() {
            if (!videoFile || questions.length === 0) return;
            
            exportBtn.disabled = true;
            exportBtn.textContent = 'Bezig met exporteren...';
            
            try {
                const zip = new JSZip();
                
                const ext = videoFile.name.split('.').pop();
                zip.file('video.' + ext, videoFile);
                
                const data = {
                    videoFileName: 'video.' + ext,
                    questions: questions
                };
                zip.file('data.json', JSON.stringify(data, null, 2));
                
                // Player HTML laden en toevoegen
                const playerResponse = await fetch(PLAYER_HTML_URL);
                const playerHTML = await playerResponse.text();
                zip.file('index.html', playerHTML);
                
                const content = await zip.generateAsync({type: 'blob'});
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'interactieve-video-' + Date.now() + '.zip';
                a.click();
                
                showMessage('Video succesvol ge√´xporteerd!', 'success');
            } catch (error) {
                showMessage('Fout bij exporteren: ' + error.message, 'error');
            } finally {
                exportBtn.disabled = false;
                exportBtn.textContent = 'üíæ Download ZIP';
            }
        });
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + secs.toString().padStart(2, '0');
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function showMessage(text, type) {
            message.className = type;
            message.textContent = text;
            message.style.display = 'block';
            setTimeout(function() { message.style.display = 'none'; }, 4000);
        }
        
        console.log('Script loaded successfully!');
        
        // Preview functionaliteit
        let previewData = null;
        let previewCurrentQ = 0;
        let previewCorrect = 0;
        let previewAnswered = new Set();
        let previewWaiting = false;
        
        document.getElementById('previewBtn').addEventListener('click', function() {
            if (questions.length === 0) {
                showMessage('Voeg eerst vragen toe om te kunnen previewen', 'error');
                return;
            }
            
            startPreview();
        });
        
        function startPreview() {
            // Reset state
            previewCurrentQ = 0;
            previewCorrect = 0;
            previewAnswered = new Set();
            previewWaiting = false;
            
            // Setup data
            previewData = {
                questions: questions
            };
            
            // Setup video
            const previewVideo = document.getElementById('previewVideo');
            previewVideo.src = videoPlayer.src;
            previewVideo.currentTime = 0;
            
            // Setup UI
            document.getElementById('previewTotal').textContent = questions.length;
            document.getElementById('previewScore').textContent = '0 / ' + questions.length;
            document.getElementById('previewCurrent').textContent = '0';
            document.getElementById('previewInfoBar').style.display = 'flex';
            document.getElementById('previewCompletion').classList.remove('active');
            
            // Show modal
            document.getElementById('previewModal').classList.add('active');
            
            // Setup event listeners
            setupPreviewEvents();
        }
        
        function setupPreviewEvents() {
            const previewVideo = document.getElementById('previewVideo');
            
            // Remove old listeners
            const newVideo = previewVideo.cloneNode(true);
            previewVideo.parentNode.replaceChild(newVideo, previewVideo);
            
            newVideo.addEventListener('timeupdate', function() {
                if (previewWaiting) return;
                const t = newVideo.currentTime;
                
                previewData.questions.forEach(function(q, i) {
                    if (!previewAnswered.has(i) && t >= q.time && t < q.time + 0.5) {
                        showPreviewQuestion(i);
                    }
                });
            });
            
            newVideo.addEventListener('ended', function() {
                if (previewAnswered.size === previewData.questions.length) {
                    showPreviewCompletion();
                }
            });
            
            document.getElementById('previewSubmitBtn').onclick = function() {
                const selected = document.querySelector('.preview-answer.selected');
                if (!selected) {
                    alert('Selecteer een antwoord');
                    return;
                }
                
                const idx = parseInt(selected.dataset.index);
                const q = previewData.questions[previewCurrentQ];
                const isCorrect = q.answers[idx].correct;
                
                const feedback = document.getElementById('previewFeedback');
                if (isCorrect) {
                    feedback.textContent = q.correctFeedback;
                    feedback.className = 'preview-feedback correct show';
                    previewCorrect++;
                } else {
                    const correctA = q.answers.find(function(a) { return a.correct; });
                    feedback.textContent = q.incorrectFeedback + ' Het juiste antwoord is: ' + correctA.text;
                    feedback.className = 'preview-feedback incorrect show';
                }
                
                document.querySelectorAll('.preview-answer').forEach(function(el, i) {
                    el.style.pointerEvents = 'none';
                    if (q.answers[i].correct) {
                        el.classList.add('correct');
                    } else if (i === idx) {
                        el.classList.add('incorrect');
                    }
                });
                
                previewAnswered.add(previewCurrentQ);
                updatePreviewScore();
                document.getElementById('previewSubmitBtn').style.display = 'none';
                document.getElementById('previewContinueBtn').style.display = 'block';
            };
            
            document.getElementById('previewContinueBtn').onclick = function() {
                document.getElementById('previewOverlay').classList.remove('active');
                previewWaiting = false;
                document.getElementById('previewVideo').play();
            };
        }
        
        function showPreviewQuestion(i) {
            const previewVideo = document.getElementById('previewVideo');
            previewVideo.pause();
            previewWaiting = true;
            previewCurrentQ = i;
            
            const q = previewData.questions[i];
            document.getElementById('previewQuestionText').textContent = q.question;
            document.getElementById('previewCurrent').textContent = previewAnswered.size + 1;
            
            const answersContainer = document.getElementById('previewAnswersContainer');
            answersContainer.innerHTML = q.answers.map(function(a, j) {
                return '<div class="preview-answer" data-index="' + j + '">' + a.text + '</div>';
            }).join('');
            
            document.querySelectorAll('.preview-answer').forEach(function(el) {
                el.onclick = function() {
                    document.querySelectorAll('.preview-answer').forEach(function(e) {
                        e.classList.remove('selected');
                    });
                    el.classList.add('selected');
                };
            });
            
            document.getElementById('previewSubmitBtn').style.display = 'block';
            document.getElementById('previewContinueBtn').style.display = 'none';
            document.getElementById('previewFeedback').className = 'preview-feedback';
            document.getElementById('previewOverlay').classList.add('active');
        }
        
        function updatePreviewScore() {
            document.getElementById('previewScore').textContent = previewCorrect + ' / ' + previewData.questions.length;
        }
        
        function showPreviewCompletion() {
            const previewVideo = document.getElementById('previewVideo');
            previewVideo.pause();
            
            const total = previewData.questions.length;
            const pct = Math.round((previewCorrect / total) * 100);
            document.getElementById('previewFinalScore').textContent = pct + '%';
            
            let msg = '';
            if (pct === 100) msg = 'Perfect! Alle vragen goed!';
            else if (pct >= 80) msg = 'Goed gedaan!';
            else if (pct >= 60) msg = 'Niet slecht!';
            else msg = 'Probeer het nog eens!';
            
            document.getElementById('previewFinalMessage').textContent = msg;
            document.getElementById('previewInfoBar').style.display = 'none';
            document.getElementById('previewCompletion').classList.add('active');
        }
        
        window.closePreview = function() {
            const previewVideo = document.getElementById('previewVideo');
            previewVideo.pause();
            document.getElementById('previewModal').classList.remove('active');
        };
        
        window.restartPreview = function() {
            document.getElementById('previewCompletion').classList.remove('active');
            document.getElementById('previewOverlay').classList.remove('active');
            startPreview();
        };
    </script>
</body>
</html>
